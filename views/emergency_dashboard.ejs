<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Dashboard - SafeZone</title>
    <link rel="stylesheet" href="/css/safezone-design-system.css">
    <link rel="stylesheet" href="/css/unified-emergency-dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>SafeZone</span>
            </div>
            <button class="logout-btn" onclick="window.location.href='/emergency_logout'">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Map Container -->
        <div id="map" class="map-container"></div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Emergency Control</h2>
                <p class="subtitle">Your safety is our priority</p>
            </div>

            <div class="info-card">
                <i class="fas fa-info-circle"></i>
                <div class="info-text">
                    <h3>Need Help?</h3>
                    <p>Press and hold the SOS button for 3 seconds. Your location will be shared with emergency services.</p>
                </div>
            </div>

            <!-- SOS Button -->
            <div class="sos-container">
                <button class="sos-btn" id="sosButton">
                    <div class="sos-ripple"></div>
                    <div class="sos-content">
                        <i class="fas fa-hand-paper"></i>
                        <span class="sos-text">SOS</span>
                        <span class="sos-hint">Hold 3 sec</span>
                    </div>
                </button>
            </div>

            <!-- Status Indicator -->
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Location tracking active</span>
            </div>
        </div>
    </main>

    <!-- Emergency Type Modal -->
    <div class="emergency-modal" id="emergencyModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Emergency Type</h2>
                <p>Choose the type of assistance you need</p>
            </div>

            <div class="emergency-options">
                <button class="emergency-option health" id="health">
                    <i class="fas fa-heartbeat"></i>
                    <span>Medical Emergency</span>
                    <small>Ambulance & Hospital</small>
                </button>

                <button class="emergency-option police" id="police">
                    <i class="fas fa-shield-alt"></i>
                    <span>Police/Safety</span>
                    <small>Law Enforcement</small>
                </button>

                <button class="emergency-option fire" id="fire">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>Fire Emergency</span>
                    <small>Fire Department</small>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-circle-notch fa-spin"></i>
            <p>Locating nearest help center...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script>
        const socket = io();
        let currentLocation = {};
        const userId = '<%= userId %>';
        let map, routingControl;
        let sosHoldTimer;

        socket.emit("register-user", userId);

        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        currentLocation = { latitude, longitude, userId };
                        console.log("Sending location:", currentLocation);
                        socket.emit("send-location", currentLocation);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showNotification("Location access denied", "error");
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 60000,
                        maximumAge: 0,
                    }
                );
            } else {
                showNotification("Geolocation not supported", "error");
            }
        }

        // SOS Button with hold functionality
        const sosButton = document.getElementById("sosButton");

        sosButton.addEventListener("mousedown", startSosHold);
        sosButton.addEventListener("mouseup", cancelSosHold);
        sosButton.addEventListener("mouseleave", cancelSosHold);
        sosButton.addEventListener("touchstart", startSosHold);
        sosButton.addEventListener("touchend", cancelSosHold);

        function startSosHold() {
            sosButton.classList.add("holding");
            sosHoldTimer = setTimeout(() => {
                sendLocation();
                document.getElementById("emergencyModal").classList.add("active");
                sosButton.classList.remove("holding");
            }, 3000);
        }

        function cancelSosHold() {
            clearTimeout(sosHoldTimer);
            sosButton.classList.remove("holding");
        }

        // Emergency type handlers
        document.getElementById("health").addEventListener("click", () => handleEmergencyType("health"));
        document.getElementById("police").addEventListener("click", () => handleEmergencyType("police"));
        document.getElementById("fire").addEventListener("click", () => handleEmergencyType("fire"));

        async function handleEmergencyType(type) {
            document.getElementById("emergencyModal").classList.remove("active");
            document.getElementById("loadingOverlay").classList.add("active");

            const emergencyData = {
                ...currentLocation,
                type: type,
                userId: userId
            };
            socket.emit("emergency", emergencyData);

            try {
                await findNearbyPlaces(type);
                document.getElementById("loadingOverlay").classList.remove("active");
                showNotification(`Emergency signal sent for ${type}!`, "success");
            } catch (error) {
                document.getElementById("loadingOverlay").classList.remove("active");
                showNotification("Error finding nearby help", "error");
            }
        }

        function initializeMap() {
            if (!map) {
                map = L.map("map").setView([currentLocation.latitude, currentLocation.longitude], 16);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "SafeZone Emergency System",
                }).addTo(map);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function findNearbyPlaces(type) {
            if (!currentLocation.latitude || !currentLocation.longitude) {
                throw new Error("Location not available");
            }

            let queryTypes = [];
            if (type === 'health') {
                queryTypes = ['hospital', 'clinic', 'doctor'];
            } else if (type === 'police') {
                queryTypes = ['police'];
            } else if (type === 'fire') {
                queryTypes = ['fire_station'];
            }

            try {
                const responses = await Promise.all(queryTypes.map(queryType => {
                    const queryUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[amenity=${queryType}](6.0,100.3,6.2,100.4);out;`;
                    return fetch(queryUrl).then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    });
                }));

                let places = [].concat(...responses.map(response => response.elements));

                if (places.length === 0) {
                    throw new Error(`No nearby ${type} found.`);
                }

                places = places.filter(place => {
                    const distance = calculateDistance(currentLocation.latitude, currentLocation.longitude, place.lat, place.lon);
                    return distance <= 20;
                });

                if (places.length === 0) {
                    throw new Error(`No nearby ${type} found within 20 km.`);
                }

                let nearestPlace = places[0];
                let minDistance = calculateDistance(currentLocation.latitude, currentLocation.longitude, nearestPlace.lat, nearestPlace.lon);

                places.forEach(place => {
                    const distance = calculateDistance(currentLocation.latitude, currentLocation.longitude, place.lat, place.lon);
                    if (distance < minDistance) {
                        nearestPlace = place;
                        minDistance = distance;
                    }
                });

                const { lat, lon } = nearestPlace;
                initializeMap();

                if (routingControl) {
                    map.removeControl(routingControl);
                }

                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(currentLocation.latitude, currentLocation.longitude),
                        L.latLng(lat, lon)
                    ],
                    routeWhileDragging: true,
                    createMarker: function(i, waypoint, n) {
                        return L.marker(waypoint.latLng).bindPopup(nearestPlace.tags.name);
                    }
                }).addTo(map);

                L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>${nearestPlace.tags.name}</b><br>${nearestPlace.tags.amenity}`).openPopup();

            } catch (error) {
                console.error("Error fetching nearby places:", error);
                throw error;
            }
        }

        function showNotification(message, type) {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Watch position
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    currentLocation = { latitude, longitude, userId };
                    socket.emit("send-location", currentLocation);
                },
                (error) => {
                    console.error("Geolocation watch error:", error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 60000,
                    maximumAge: 0,
                }
            );
        }
    </script>
</body>
</html>
